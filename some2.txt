using System;
using System.Collections.Generic;
using System.IO;
using System.Runtime.InteropServices;
using System.Runtime.InteropServices.ComTypes;

static class User32
{
    [DllImport("user32.dll", CharSet = CharSet.Unicode)]
    public static extern ushort RegisterClipboardFormat(string lpszFormat);
}

static class Kernel32
{
    [DllImport("kernel32.dll")]
    public static extern IntPtr GlobalLock(IntPtr hMem);

    [DllImport("kernel32.dll")]
    [return: MarshalAs(UnmanagedType.Bool)]
    public static extern bool GlobalUnlock(IntPtr hMem);
}

static class StructuredStorage
{
    private const uint STGM_CREATE = 0x00001000;
    private const uint STGM_READWRITE = 0x00000002;
    private const uint STGM_SHARE_EXCLUSIVE = 0x00000010;

    [DllImport("ole32.dll", CharSet = CharSet.Unicode)]
    public static extern int StgCreateDocfile(
        string pwcsName,
        uint grfMode,
        uint reserved,
        out IStorage ppstgOpen);

    public static void SaveIStorageToFile(IStorage src, string path)
    {
        Ole32.ThrowIfFailed(StgCreateDocfile(
            path,
            STGM_CREATE | STGM_READWRITE | STGM_SHARE_EXCLUSIVE,
            0,
            out var dst));

        try
        {
            src.CopyTo(0, null, IntPtr.Zero, dst);
            dst.Commit(0);
        }
        finally
        {
            Marshal.ReleaseComObject(dst);
        }
    }
}
