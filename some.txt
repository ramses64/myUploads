private static uint ChooseEffect(uint allowedBySource, uint keyState)
{
    const uint DROPEFFECT_NONE = 0;
    const uint DROPEFFECT_COPY = 1;
    const uint DROPEFFECT_MOVE = 2;

    bool ctrl = (keyState & 0x0008) != 0; // MK_CONTROL

    // prefer Copy when CTRL is down, otherwise Move (typical behavior)
    if (ctrl && (allowedBySource & DROPEFFECT_COPY) != 0) return DROPEFFECT_COPY;
    if (!ctrl && (allowedBySource & DROPEFFECT_MOVE) != 0) return DROPEFFECT_MOVE;

    // fallback: any allowed effect
    if ((allowedBySource & DROPEFFECT_COPY) != 0) return DROPEFFECT_COPY;
    if ((allowedBySource & DROPEFFECT_MOVE) != 0) return DROPEFFECT_MOVE;

    return DROPEFFECT_NONE;
}