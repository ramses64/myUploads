using System.Net.Http.Headers;

public interface ISentMailEmlExporter
{
    Task ExportMessageAsEmlAsync(string userId, string messageId);
}

public class SentMailEmlExporter : ISentMailEmlExporter
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly IAppGraphTokenProvider _tokenProvider;
    private readonly IWebHostEnvironment _env;

    public SentMailEmlExporter(IHttpClientFactory httpClientFactory, IAppGraphTokenProvider tokenProvider, IWebHostEnvironment env)
    {
        _httpClientFactory = httpClientFactory;
        _tokenProvider = tokenProvider;
        _env = env;
    }

    public async Task ExportMessageAsEmlAsync(string userId, string messageId)
    {
        var token = await _tokenProvider.GetAppTokenAsync();
        var http = _httpClientFactory.CreateClient();

        // 1) Download MIME content (this is the .eml content) 
        var mimeUrl = $"https://graph.microsoft.com/v1.0/users/{userId}/messages/{messageId}/$value";

        using var req = new HttpRequestMessage(HttpMethod.Get, mimeUrl);
        req.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

        using var res = await http.SendAsync(req);
        if (!res.IsSuccessStatusCode)
            return; // log in real app

        var bytes = await res.Content.ReadAsByteArrayAsync();

        // 2) Save to a folder (no DB). Put it somewhere safe/not web-accessible by default.
        var outDir = Path.Combine(_env.ContentRootPath, "App_Data", "eml");
        Directory.CreateDirectory(outDir);

        var filePath = Path.Combine(outDir, $"{DateTime.UtcNow:yyyyMMdd-HHmmss}-{messageId}.eml");
        await File.WriteAllBytesAsync(filePath, bytes);
    }
}
