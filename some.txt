using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;

[Authorize]
[Route("graph")]
public class GraphSetupController : Controller
{
    private readonly IGraphSubscriptionService _subs;

    public GraphSetupController(IGraphSubscriptionService subs) => _subs = subs;

    [HttpPost("subscribe-sentitems")]
    [ValidateAntiForgeryToken]
    public async Task<IActionResult> SubscribeSentItems()
    {
        // You need the user's AAD object id or UPN email. Object id is best.
        var userId = User.FindFirstValue("http://schemas.microsoft.com/identity/claims/objectidentifier")
                     ?? throw new InvalidOperationException("No object id claim.");

        var subId = await _subs.EnsureSubscriptionAsync(userId);
        return Ok(new { subscriptionId = subId });
    }
}
