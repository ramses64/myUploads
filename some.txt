private bool _oleInitialized;
private IntPtr _hwnd;
private OutlookAsyncDropTarget _dropTarget;

protected override void OnSourceInitialized(EventArgs e)
{
    base.OnSourceInitialized(e);

    _hwnd = new WindowInteropHelper(this).Handle;

    // Initialize OLE for drag & drop
    int hrOle = Ole32.OleInitialize(IntPtr.Zero);
    if (hrOle == 0 || hrOle == 1) // S_OK (0) or S_FALSE (1) both mean "initialized"
        _oleInitialized = true;
    else
    {
        MessageBox.Show($"OleInitialize failed: 0x{hrOle:X8}");
        return;
    }

    _dropTarget = new OutlookAsyncDropTarget(_hwnd, AddPathsToUi);

    int hr = Ole32.RegisterDragDrop(_hwnd, _dropTarget);
    if (hr != 0)
        MessageBox.Show($"RegisterDragDrop failed: 0x{hr:X8}");
}

protected override void OnClosed(EventArgs e)
{
    try { Ole32.RevokeDragDrop(_hwnd); } catch { }

    if (_oleInitialized)
        Ole32.OleUninitialize();

    base.OnClosed(e);
}
