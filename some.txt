using Microsoft.Identity.Client;

public interface IAppGraphTokenProvider
{
    Task<string> GetAppTokenAsync();
}

public class AppGraphTokenProvider : IAppGraphTokenProvider
{
    private readonly IConfidentialClientApplication _cca;
    private static readonly string[] Scopes = new[] { "https://graph.microsoft.com/.default" };

    public AppGraphTokenProvider(IConfiguration config)
    {
        _cca = ConfidentialClientApplicationBuilder
            .Create(config["AzureAd:ClientId"])
            .WithClientSecret(config["AzureAd:ClientSecret"])
            .WithAuthority($"{config["AzureAd:Instance"]}{config["AzureAd:TenantId"]}")
            .Build();
    }

    public async Task<string> GetAppTokenAsync()
    {
        var res = await _cca.AcquireTokenForClient(Scopes).ExecuteAsync();
        return res.AccessToken;
    }
}
