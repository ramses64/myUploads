using System.Net.Http.Headers;
using System.Text;
using System.Text.Json;

public interface IGraphSubscriptionService
{
    Task<string> EnsureSubscriptionAsync(string userId);
}

public class GraphSubscriptionService : IGraphSubscriptionService
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly IAppGraphTokenProvider _tokenProvider;
    private readonly IConfiguration _config;

    public GraphSubscriptionService(
        IHttpClientFactory httpClientFactory,
        IAppGraphTokenProvider tokenProvider,
        IConfiguration config)
    {
        _httpClientFactory = httpClientFactory;
        _tokenProvider = tokenProvider;
        _config = config;
    }

    public async Task<string> EnsureSubscriptionAsync(string userId)
    {
        // In production you’d store/renew subscription IDs.
        // For demo: just create a new one (you’ll want cleanup/renewal later).
        var token = await _tokenProvider.GetAppTokenAsync();
        var http = _httpClientFactory.CreateClient();

        var notificationUrl = _config["Graph:NotificationUrl"]; // e.g. https://xxxx.ngrok-free.app/graph/notifications
        var clientState = _config["Graph:ClientStateSecret"];   // random secret string

        // Messages subscriptions have limited max expiration; keep it short + renew.
        var expiration = DateTimeOffset.UtcNow.AddHours(12);

        var payload = new
        {
            changeType = "created",
            notificationUrl = notificationUrl,
            resource = $"users/{userId}/mailFolders('SentItems')/messages",
            expirationDateTime = expiration,
            clientState = clientState,
            // optional: includeResourceData = true (then you must handle encryption) -> skip for simplicity
        };

        using var req = new HttpRequestMessage(HttpMethod.Post, "https://graph.microsoft.com/v1.0/subscriptions");
        req.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
        req.Content = new StringContent(JsonSerializer.Serialize(payload), Encoding.UTF8, "application/json");

        using var res = await http.SendAsync(req);
        var body = await res.Content.ReadAsStringAsync();
        if (!res.IsSuccessStatusCode)
            throw new InvalidOperationException($"Subscription create failed: {res.StatusCode} - {body}");

        using var doc = JsonDocument.Parse(body);
        return doc.RootElement.GetProperty("id").GetString()!;
    }
}
