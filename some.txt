[Authorize]
[Route("graph")]
public class GraphDebugController : Controller
{
    private readonly IAppGraphTokenProvider _tokenProvider;
    private readonly IHttpClientFactory _httpClientFactory;

    public GraphDebugController(
        IAppGraphTokenProvider tokenProvider,
        IHttpClientFactory httpClientFactory)
    {
        _tokenProvider = tokenProvider;
        _httpClientFactory = httpClientFactory;
    }

    [HttpGet("subscriptions")]
    public async Task<IActionResult> ListSubscriptions()
    {
        var token = await _tokenProvider.GetAppTokenAsync();
        var http = _httpClientFactory.CreateClient();

        using var req = new HttpRequestMessage(
            HttpMethod.Get,
            "https://graph.microsoft.com/v1.0/subscriptions");

        req.Headers.Authorization =
            new AuthenticationHeaderValue("Bearer", token);

        using var res = await http.SendAsync(req);
        var body = await res.Content.ReadAsStringAsync();

        return Content(body, "application/json");
    }
}
