private static string GetUniquePath(string baseDir, string fileName, HashSet<string> usedNames)
{
    // Make sure the name is safe; also handle empty names
    fileName = MakeSafeFileName(fileName);
    if (string.IsNullOrWhiteSpace(fileName))
        fileName = "drop.msg";

    string nameWithoutExt = Path.GetFileNameWithoutExtension(fileName);
    string ext = Path.GetExtension(fileName);

    string candidate = fileName;
    int n = 1;

    while (usedNames.Contains(candidate) || File.Exists(Path.Combine(baseDir, candidate)))
    {
        n++;
        candidate = $"{nameWithoutExt} ({n}){ext}";
    }

    usedNames.Add(candidate);
    return Path.Combine(baseDir, candidate);
}