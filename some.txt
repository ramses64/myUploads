var resource = n.GetProperty("resource").GetString() ?? "";
var resourceData = n.GetProperty("resourceData");

// messageId
var messageId = resourceData.TryGetProperty("id", out var idProp) ? idProp.GetString() : null;

// userId: try resourceData first
var userId = resourceData.TryGetProperty("userId", out var userProp) ? userProp.GetString() : null;

// fallback: parse from resource: "users/{userId}/mailFolders('SentItems')/messages/{messageId}"
if (string.IsNullOrWhiteSpace(userId))
{
    const string prefix = "users/";
    var start = resource.IndexOf(prefix, StringComparison.OrdinalIgnoreCase);
    if (start >= 0)
    {
        start += prefix.Length;
        var end = resource.IndexOf('/', start);
        if (end > start)
            userId = resource.Substring(start, end - start);
    }
}

if (!string.IsNullOrWhiteSpace(userId) && !string.IsNullOrWhiteSpace(messageId))
{
    await _exporter.ExportMessageAsEmlAsync(userId!, messageId!);
}
