using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

[Authorize]
[Route("eml")]
public class EmlController : Controller
{
    private readonly IWebHostEnvironment _env;

    public EmlController(IWebHostEnvironment env) => _env = env;

    [HttpGet]
    public IActionResult Index()
    {
        var dir = Path.Combine(_env.ContentRootPath, "App_Data", "eml");
        Directory.CreateDirectory(dir);

        var files = Directory.GetFiles(dir, "*.eml")
            .OrderByDescending(f => f)
            .Select(Path.GetFileName)
            .ToList();

        return Ok(files); // replace with a view if you want
    }

    [HttpGet("{fileName}")]
    public IActionResult Download(string fileName)
    {
        var dir = Path.Combine(_env.ContentRootPath, "App_Data", "eml");
        var path = Path.Combine(dir, fileName);

        if (!System.IO.File.Exists(path))
            return NotFound();

        var bytes = System.IO.File.ReadAllBytes(path);
        return File(bytes, "message/rfc822", fileName);
    }
}
